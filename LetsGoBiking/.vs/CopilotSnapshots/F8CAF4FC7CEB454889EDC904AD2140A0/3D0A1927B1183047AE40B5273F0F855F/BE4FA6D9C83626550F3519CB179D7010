using LetsGoBiking.Shared;
using System;
using System.Linq;
using System.ServiceModel;
using System.ServiceModel.Web;
using LetsGoBiking.ProxyCacheServer;

namespace LetsGoBiking.ProxyCacheServer
{
    [ServiceBehavior(InstanceContextMode = InstanceContextMode.Single)]
    public class ProxyService : IProxyService
    {
        private readonly GenericProxyCache<JCDecauxStations> _cache;
        private const double CACHE_DURATION_SECONDS = 300; // 5 minutes

        public ProxyService()
        {
            _cache = new GenericProxyCache<JCDecauxStations>();
        }

        public StationInfo[] GetStations(string city)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(city))
                {
                    Console.WriteLine("GetStations called with empty city");
                    return new StationInfo[0];
                }

                city = city.ToLower().Trim();
                Console.WriteLine($"GetStations called for city: {city}");

                // Use cache with factory function
                var cacheKey = $"stations_{city}";
                
                var stationData = _cache.Get(
                    cacheKey,
                    () => new JCDecauxStations(city),
                    CACHE_DURATION_SECONDS
                );

                if (stationData?.Stations != null)
                {
                    Console.WriteLine($"Returning {stationData.Stations.Length} stations for {city}");
                    return stationData.Stations;
                }
                
                Console.WriteLine($"No stations found for {city}");
                return new StationInfo[0];
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error in GetStations for {city}: {ex.Message}");
                return new StationInfo[0];
            }
        }


        public ForceStationResponse ForceStationUnavailable(string stationId, string city)
        {
            try
            {
                
                if (WebOperationContext.Current != null)
                {
                    var ctx = WebOperationContext.Current.OutgoingResponse;
                    ctx.Headers.Add("Access-Control-Allow-Origin", "*");
                    ctx.Headers.Add("Access-Control-Allow-Methods", "POST, GET, OPTIONS");
                    ctx.Headers.Add("Access-Control-Allow-Headers", "Content-Type");
                }

                Console.WriteLine($"[ForceStation] Request: stationId={stationId}, city={city}");

                // Validate
                if (string.IsNullOrWhiteSpace(stationId) || string.IsNullOrWhiteSpace(city))
                    return new ForceStationResponse { Success = false, Message = "Missing parameters" };

                city = city.ToLower().Trim();
                if (!int.TryParse(stationId, out int stationIdInt))
                    return new ForceStationResponse { Success = false, Message = "Invalid stationId" };

                // Get from cache
                var cacheKey = $"stations_{city}";
                var stationData = _cache.Get(cacheKey);

                if (stationData?.Stations == null || stationData.Stations.Length == 0)
                    return new ForceStationResponse { Success = false, Message = "No station data. Call GetStations first." };

                // Find station
                var station = FindStation(stationData.Stations, stationIdInt);
                if (station == null)
                    return new ForceStationResponse { Success = false, Message = $"Station {stationIdInt} not found" };

                // Modify station
                int originalBikes = station.AvailableBikes;
                station.AvailableBikes = 0;
                station.Status = "UNAVAILABLE";

                Console.WriteLine($"[ForceStation] Modified: {station.Name}");
                Console.WriteLine($"[ForceStation] Bikes: {originalBikes} → 0");

                // Publish to ActiveMQ
                var alert = new StationAlertMessage
                {
                    StationId = stationIdInt,
                    City = city,
                    StationName = station.Name,
                    Latitude = station.Latitude,
                    Longitude = station.Longitude,
                    AvailableBikes = 0,
                    AvailableStands = station.AvailableStands,
                    Message = "NO_BIKES"
                };

                ActiveMQProducerService.Instance.PublishStationAlert(alert);

                return new ForceStationResponse
                {
                    Success = true,
                    Message = "Station forced unavailable. Alert published.",
                    StationName = station.Name,
                    PreviousBikes = originalBikes,
                    CurrentBikes = 0
                };
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[ForceStation] Error: {ex.Message}");
                return new ForceStationResponse { Success = false, Message = ex.Message };
            }
        }

        private StationInfo FindStation(StationInfo[] stations, int id)
        {
            // Try to find by station number
            var station = stations.FirstOrDefault(s => ExtractStationNumber(s.Name) == id);

            // Fallback: find by name containing ID
            if (station == null)
                station = stations.FirstOrDefault(s => s.Name.Contains(id.ToString()));

            return station;
        }

        private int ExtractStationNumber(string name)
        {
            if (string.IsNullOrEmpty(name)) return -1;

            foreach (var part in name.Split('-', ' ', '_'))
            {
                if (int.TryParse(part.Trim(), out int num))
                    return num;
            }
            return -1;
        }
    }
}
