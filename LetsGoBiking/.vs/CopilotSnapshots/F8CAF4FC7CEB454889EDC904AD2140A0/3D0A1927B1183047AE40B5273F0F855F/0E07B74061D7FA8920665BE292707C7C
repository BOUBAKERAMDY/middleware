using Apache.NMS;
using Apache.NMS.ActiveMQ;
using Newtonsoft.Json;
using System;
using System.ServiceModel.Channels;

namespace LetsGoBiking.ProxyCacheServer
{
    public class StationAlert
    {
        public int StationId { get; set; }
        public string City { get; set; }
        public string StationName { get; set; }
        public int AvailableBikes { get; set; }
        public int AvailableStands { get; set; }
        public string Message { get; set; }
        public DateTime Timestamp { get; set; }
    }

    public class ActiveMQProducer : IDisposable
    {
        private IConnectionFactory _connectionFactory;
        private IConnection _connection;
        private Apache.NMS.ISession _session;
        private IMessageProducer _producer;
        private bool _disposed = false;

        private const string BROKER_URI = "tcp://localhost:61616";
        private const string TOPIC_NAME = "stationAlerts";

        public ActiveMQProducer()
        {
            Initialize();
        }

        private void Initialize()
        {
            try
            {
                // Create connection factory
                _connectionFactory = new ConnectionFactory(BROKER_URI);

                // Create connection
                _connection = _connectionFactory.CreateConnection();
                _connection.Start();

                // Create session
                _session = _connection.CreateSession(AcknowledgementMode.AutoAcknowledge);

                // Create topic
                ITopic topic = _session.GetTopic(TOPIC_NAME);

                // Create producer
                _producer = _session.CreateProducer(topic);
                _producer.DeliveryMode = MsgDeliveryMode.NonPersistent;

                Console.WriteLine($"[ActiveMQ] Producer initialized for topic: {TOPIC_NAME}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[ActiveMQ] Error initializing producer: {ex.Message}");
                throw;
            }
        }

        public void PublishStationAlert(StationAlert alert)
        {
            try
            {
                if (_producer == null)
                {
                    Console.WriteLine("[ActiveMQ] Producer not initialized");
                    return;
                }

                // Set timestamp
                alert.Timestamp = DateTime.UtcNow;

                // Serialize to JSON
                string jsonMessage = JsonConvert.SerializeObject(alert);

                // Create text message
                ITextMessage message = _session.CreateTextMessage(jsonMessage);

                // Add custom headers
                message.Properties["stationId"] = alert.StationId;
                message.Properties["city"] = alert.City;
                message.Properties["messageType"] = alert.Message;

                // Send message
                _producer.Send(message);

                Console.WriteLine($"[ActiveMQ] Published alert: {alert.Message} for station {alert.StationName} ({alert.City})");
                Console.WriteLine($"[ActiveMQ] Message content: {jsonMessage}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[ActiveMQ] Error publishing message: {ex.Message}");
            }
        }

        public void Dispose()
        {
            Dispose(true);
            GC.SuppressFinalize(this);
        }

        protected virtual void Dispose(bool disposing)
        {
            if (!_disposed)
            {
                if (disposing)
                {
                    try
                    {
                        _producer?.Close();
                        _session?.Close();
                        _connection?.Close();
                        Console.WriteLine("[ActiveMQ] Producer disposed");
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"[ActiveMQ] Error disposing: {ex.Message}");
                    }
                }
                _disposed = true;
            }
        }

        ~ActiveMQProducer()
        {
            Dispose(false);
        }
    }
}